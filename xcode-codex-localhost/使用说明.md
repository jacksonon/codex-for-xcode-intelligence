本地 Codex 直通与 Xcode 接入说明

概览
- 你可以在本机以两种方式使用已安装的 Codex：
  - 直通转发器（推荐）：把你的问题原样转发给 `codex exec` 并原样返回回答，不做任何 OpenAI 接口包装。
  - OpenAI 兼容服务（用于 Xcode Locally Hosted）：提供 `/v1/models` 与 `/v1/chat/completions` 接口，方便 Xcode 指向本地服务。

目录结构
- `xcode-codex-localhost/forwarder.js`：极简 HTTP 直通转发（POST `/ask`）。
- `xcode-codex-localhost/ask-codex.js`：命令行直通转发脚本。
- `xcode-codex-localhost/server.js`：OpenAI 兼容服务（给 Xcode 用）。
- `xcode-codex-localhost/README.md`：英文简要说明。

先决条件
- Node.js 18+（`node -v`）
- 已安装 Codex CLI 且可用（`codex --version`）

环境变量（通用）
- `CODEX_BIN`：Codex 可执行路径，默认 `codex`。建议用 `CODEX_BIN="$(which codex)"` 显式指定。
- `CODEX_WORKDIR`：在该目录下运行 `codex exec`（不设定则为当前目录）。
- `EXEC_TIMEOUT_MS`：一次请求的最大执行时长，默认 120000 毫秒。
- `FORCE_NON_STREAM` / `DISABLE_STREAM`：设置任意值后，忽略客户端的 `stream:true`，一律返回非流式响应（便于兼容不支持流式的 IDE）。
- `FORCE_STREAM`：设置任意值后，强制以 SSE 流式返回（即使客户端未传 `stream:true`）。

一、直通转发器（不包装 OpenAI 接口）
1) 启动服务（在一个终端窗口保持运行）
```
CODEX_BIN="$(which codex)" node xcode-codex-localhost/forwarder.js
```
服务地址：`http://127.0.0.1:3050`

2) 健康检查
```
curl -i http://127.0.0.1:3050/health
```

3) 发送问题（两种方式任意其一）
- JSON：
```
curl -i -X POST http://127.0.0.1:3050/ask \
  -H 'Content-Type: application/json' \
  -d '{"q":"解释这个项目的目标"}'
```
- 纯文本：
```
curl -i -X POST http://127.0.0.1:3050/ask \
  --data-binary @- <<< '解释这个项目的目标'
```
返回值：`text/plain`，即 Codex 的最终回答。

4) 命令行脚本（无需 HTTP 服务）
```
node xcode-codex-localhost/ask-codex.js "解释这个项目的目标"
# 或
echo '解释这个项目的目标' | node xcode-codex-localhost/ask-codex.js
```

二、OpenAI 兼容服务（用于 Xcode Locally Hosted）
1) 启动服务
```
# 推荐（IDE 常用，强制 SSE 流式）：
xcode-codex-localhost/start-stream.sh

# 若 IDE 仅支持非流式：
xcode-codex-localhost/start-nonstream.sh
```
服务地址：`http://127.0.0.1:3040`

2) 健康检查
```
curl -i http://127.0.0.1:3040/health
```

3) 模型列表
```
curl -i http://127.0.0.1:3040/v1/models
```

4) Chat Completions（非流式示例）
```
curl -i http://127.0.0.1:3040/v1/chat/completions \
  -H 'Content-Type: application/json' \
  -d '{"model":"codex-exec","messages":[{"role":"user","content":"解释这个项目的目标"}]}'
```

5) Xcode Locally Hosted 配置
- Base URL：`http://127.0.0.1:3040`
- API Key：可留空（如果 UI 强制，可随意填写占位符）
- Model：`codex-exec`

常见问题与排查
- 请求“没反应”/一直等待：
  - 检查日志是否提示 `Failed to start codex` 或 `Timed out after ...ms`；
  - 确认 Codex 可执行存在：`which codex && codex --version`；
  - 直接运行：`codex exec --json "hello"`，若需要登录或鉴权，请先完成登录，或设置 `CODEX_API_KEY` 后重试；
  - 端口是否被占用；服务已绑定 `127.0.0.1`，确保本机防火墙允许本地回环；
  - 如任务较重可调大 `EXEC_TIMEOUT_MS`，例如 `EXEC_TIMEOUT_MS=180000`。
- Git 仓库检查：
  - 本服务启动 codex 时始终附带 `--skip-git-repo-check`，即使不在 Git 仓库也能执行；
  - 若你在终端自己直接运行 `codex exec`，请带上该参数：
    - `codex exec --json --skip-git-repo-check "hello"`
- 500 Failed to start codex：
  - 设置 `CODEX_BIN="$(which codex)"` 或把 codex 加入 PATH；
  - 确保当前用户有权限执行 codex。
- 500 Timed out after ...ms：
  - 任务执行超时；提高超时时长或缩小任务范围；
  - 检查 `CODEX_WORKDIR` 是否正确（仓库/项目路径）。
- Codex 报错 `failed to initialize rollout recorder: Operation not permitted`：
  - 这通常与受限运行环境/权限有关（例如无权写入 Codex 的会话目录）；
  - 在正常的本机终端运行，确保用户目录可写；必要时以同一用户手动运行一次 `codex exec --json "hello"` 初始化。
- Xcode 无法连接：
  - 确认 URL、端口一致；
  - Headers 必须是 `Content-Type: application/json`（不要写成 `Content -Type` 或换行错位）。

安全与注意事项
- 两个服务都仅监听 `127.0.0.1`，不会暴露到外网。
- 默认使用 `--skip-git-repo-check`，避免非仓库目录下报错；若你希望强制在仓库内执行，可去掉该 flag 并指定 `CODEX_WORKDIR`。
- 若你已在 Codex CLI 配置了 MCP 工具（如网页检索），它们会在 `codex exec` 会话中按你的 Codex 设置生效，无需本服务额外改动。

实用示例速查
- 一条命令发问（CLI）
```
node xcode-codex-localhost/ask-codex.js "解释这个项目的目标"
```
- 直通转发器（HTTP JSON）
```
curl -s http://127.0.0.1:3050/ask -H 'Content-Type: application/json' -d '{"q":"解释这个项目的目标"}'
```
- OpenAI 兼容（Xcode 用）
```
curl -s http://127.0.0.1:3040/v1/chat/completions -H 'Content-Type: application/json' -d '{"model":"codex-exec","messages":[{"role":"user","content":"解释这个项目的目标"}]}'
```
